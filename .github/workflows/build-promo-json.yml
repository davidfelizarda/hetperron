name: Build promo.json

on:
  push:
    paths:
      - "docs/promo/**"
      - ".github/workflows/build-promo-json.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate promo.json
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const promoDir = path.join(process.cwd(), 'docs', 'promo');
          const exts = new Set(['.jpg', '.jpeg', '.png', '.webp', '.gif']);

          const files = fs.readdirSync(promoDir, { withFileTypes: true })
            .filter(d => d.isFile())
            .map(d => d.name)
            .filter(name => exts.has(path.extname(name).toLowerCase()))
            .sort((a,b) => a.localeCompare(b, 'en', { numeric: true, sensitivity: 'base' }))
            .map(name => `promo/${name}`);

          fs.writeFileSync(
            path.join(promoDir, 'promo.json'),
            JSON.stringify(files, null, 2)
          );
          NODE

      - name: Commit promo.json if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/promo/promo.json
          git diff --cached --quiet || git commit -m "update promo.json"
          git push
